services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: ${POSTGRES_CONTAINER:-gourls-postgres}
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-gourls}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-gourls_secure_password}
    volumes:
      - ${VOLUME_NAME:-postgres_data}:/var/lib/postgresql/data
      - ./docker/init-db:/docker-entrypoint-initdb.d
    ports:
      - "${POSTGRES_PORT:-3432}:${POSTGRES_INTERNAL_PORT:-5432}"
    networks:
      - ${NETWORK_NAME:-gourls-network}
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-gourls}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # .NET API Backend
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: ${API_CONTAINER:-gourls-api}
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ConnectionStrings__DefaultConnection=Host=${POSTGRES_HOST:-postgres};Port=${POSTGRES_INTERNAL_PORT:-5432};Database=${POSTGRES_DB:-gourls};Username=${POSTGRES_USER:-postgres};Password=${POSTGRES_PASSWORD:-gourls_secure_password}
      - ASPNETCORE_URLS=http://+:${API_INTERNAL_PORT:-5000}
      - ASPNETCORE_HTTPS_PORT=
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-gourls}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gourls_secure_password}
      - RESERVED_WORDS=${RESERVED_WORDS}
      # User management environment variables
      - CURRENT_USER=${CURRENT_USER:-system}
      - Authentication__DefaultUser=${AUTHENTICATION_DEFAULT_USER:-system}
      - Authentication__Mode=${AUTHENTICATION_MODE:-Environment}
    ports:
      - "${API_PORT:-5000}:${API_INTERNAL_PORT:-5000}"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ${NETWORK_NAME:-gourls-network}
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${API_INTERNAL_PORT:-5000}/api/urls"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Angular Frontend (built as static files)
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      args:
        - BASE_URL=${FRONTEND_BASE_URL:-/}
        - GO_DOMAIN=${GO_DOMAIN:-go}
        - API_URL=${FRONTEND_API_URL:-/api}
        - IS_PRODUCTION=${IS_PRODUCTION:-true}
    container_name: ${FRONTEND_CONTAINER:-gourls-frontend}
    ports:
      - "${FRONTEND_PORT:-8080}:${FRONTEND_INTERNAL_PORT:-80}"
    networks:
      - ${NETWORK_NAME:-gourls-network}
    restart: ${RESTART_POLICY:-unless-stopped}

  # nginx Reverse Proxy
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    container_name: ${NGINX_CONTAINER:-gourls-nginx}
    ports:
      - "${NGINX_PORT:-80}:${FRONTEND_INTERNAL_PORT:-80}"
    depends_on:
      - frontend
      - api
    networks:
      - ${NETWORK_NAME:-gourls-network}
    restart: ${RESTART_POLICY:-unless-stopped}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  gourls-network:
    name: ${NETWORK_NAME:-gourls-network}
    driver: bridge

volumes:
  postgres_data:
    name: ${VOLUME_NAME:-postgres_data}
    driver: local